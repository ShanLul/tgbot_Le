# Telegram 智能算价机器人 - 项目规划文档

## 一、项目概述

### 1.1 项目背景
开发一个Telegram机器人，用于识别客户订单中的价格信息，并自动汇总到群组账单中。

### 1.2 核心功能
- 自动识别订单文本/图片中的价格信息
- 按群组独立管理账单
- 用户权限管理（普通用户/管理员）
- 账单调整功能（+金额/-金额）
- 清账功能

---

## 二、项目结构

```
LeBot2/
├── app/
│   ├── main.py              # FastAPI入口文件
│   ├── bot/
│   │   ├── __init__.py
│   │   ├── handler.py       # Telegram消息处理器
│   │   ├── commands.py      # 命令处理模块
│   │   └── config.py        # 配置文件(TOKEN, 管理员ID)
│   ├── services/
│   │   ├── __init__.py
│   │   ├── ocr_service.py   # OCR图片识别服务
│   │   └── price_parser.py  # 价格解析与计算服务
│   ├── models/
│   │   ├── __init__.py
│   │   ├── database.py      # 数据库模型定义
│   │   └── schemas.py       # Pydantic数据模型
│   ├── api/
│   │   ├── __init__.py
│   │   └── routes.py        # API路由(Web管理后台)
│   └── utils/
│       ├── __init__.py
│       └── auth.py          # 权限验证工具
├── data/
│   └── bot.db               # SQLite数据库文件
├── logs/
│   └── bot.log              # 日志文件
├── requirements.txt         # 项目依赖
├── .env                     # 环境变量配置
├── .gitignore              # Git忽略文件
└── README.md               # 项目说明
```

---

## 三、功能模块详解

### 3.1 消息接收模块

**触发机制：** 用户报单时必须在消息前加 `a` 或 `A` 前缀，避免日常聊天误触发。

| 消息类型 | 触发方式 | 处理方式 |
|----------|----------|----------|
| 文本消息 | 以 `a` 或 `A` 开头 | 正则解析价格信息 |
| 图片消息 | 以 `a` 或 `A` 开头 | OCR识别后解析价格 |
| 其他消息 | 无前缀 | 忽略，不处理 |

**报单格式示例：**

```
a d程
13045201820
黑龙江省齐齐哈尔市依安县依安镇翰林新居六栋一单元

雪茄鸭嘴兽 铁观音 绿豆 备选龙井
高维 绿豆 备选蓝莓
总186
```

或

```
A d程
13045201820
黑龙江省齐齐哈尔市依安县依安镇翰林新居六栋一单元

雪茄鸭嘴兽 铁观音 绿豆 备选龙井
高维 绿豆 备选蓝莓
总60*2+60+6=186
```

### 3.2 价格识别模块

**支持的输入格式：**

| 格式示例 | 识别结果 | 说明 |
|----------|----------|------|
| `总186` | 186 | 直接提取数字 |
| `总60*2+60+6=186` | 186 | 计算验证后提取 |
| `总价: 186元` | 186 | 去除单位符号 |
| `合计=186` | 186 | 识别等号后数字 |

**解析逻辑：**
1. 正则匹配 `总` `合计` `总价` 等关键词
2. 提取等号后的数字，或计算算式结果
3. 验证计算结果一致性（如有算式）

### 3.3 账单管理模块

**账单规则：**
- 每个群组（chat_id）独立维护一份账单
- 所有用户提交的订单金额累加到群组账单
- 账单持久化存储到数据库

### 3.4 权限系统

| 用户类型 | 可用操作 |
|----------|----------|
| **普通用户** | - 发送订单（文本/图片）<br>- 查看当前账单<br>- 查看账单历史 |
| **管理员** | - 普通用户所有权限<br>- `+金额` 增加账单<br>- `-金额` 减少账单<br>- `清账` 清空账单 |
| **超级管理员** | - 管理员所有权限<br>- 设置/取消群组管理员 |

### 3.5 指令系统

| 指令 | 格式 | 说明 | 权限要求 |
|------|------|------|----------|
| `/start` | `/start` | 开始使用，显示帮助 | 所有用户 |
| `/bill` | `/bill` 或 `/账单` | 查看当前群组账单 | 所有用户 |
| `/history` | `/history` | 查看账单变动历史 | 所有用户 |
| `/help` | `/help` | 显示帮助信息 | 所有用户 |
| `+金额` | `+100` | 增加指定金额到账单 | 管理员 |
| `-金额` | `-100` | 从账单减去指定金额 | 管理员 |
| `清账` | `清账` | 清空账单并删除该群组所有历史数据 | 管理员 |
| `/set_admin` | `/set_admin @user` | 设置群组管理员 | 超级管理员 |

---

## 四、数据库设计

### 4.1 群组表 (groups)

| 字段 | 类型 | 说明 |
|------|------|------|
| id | Integer | 主键 |
| chat_id | BigInteger | Telegram群组ID |
| group_name | String | 群组名称 |
| total_amount | Decimal | 当前账单总额 |
| created_at | DateTime | 创建时间 |
| updated_at | DateTime | 更新时间 |

### 4.2 订单记录表 (orders)

| 字段 | 类型 | 说明 |
|------|------|------|
| id | Integer | 主键 |
| chat_id | BigInteger | 所属群组ID |
| user_id | BigInteger | 提交用户ID |
| user_name | String | 提交用户名 |
| amount | Decimal | 订单金额 |
| raw_text | Text | 原始订单文本 |
| created_at | DateTime | 创建时间 |

### 4.3 账单变动表 (transactions)

| 字段 | 类型 | 说明 |
|------|------|------|
| id | Integer | 主键 |
| chat_id | BigInteger | 所属群组ID |
| user_id | BigInteger | 操作用户ID |
| user_name | String | 操作用户名 |
| type | String | 类型: order/add/reduce/clear |
| amount | Decimal | 变动金额 |
| note | String | 备注 |
| created_at | DateTime | 创建时间 |

### 4.4 管理员表 (admins)

| 字段 | 类型 | 说明 |
|------|------|------|
| id | Integer | 主键 |
| user_id | BigInteger | Telegram用户ID |
| chat_id | BigInteger | 群组ID (NULL表示超级管理员) |
| is_super_admin | Boolean | 是否超级管理员 |
| created_at | DateTime | 创建时间 |

---

## 五、技术栈

| 技术 | 用途 |
|------|------|
| FastAPI | Web框架，提供异步支持 |
| python-telegram-bot | Telegram Bot API 封装 |
| SQLAlchemy | ORM数据库操作 |
| SQLite | 数据存储（可升级至PostgreSQL） |
| Pydantic | 数据验证 |
| python-dotenv | 环境变量管理 |
| aiohttp | 异步HTTP客户端 |
| re (正则) | 价格文本解析 |
| PIL/OpenCV | 图片预处理（如需OCR） |

---

## 六、开发阶段规划

### 阶段一：基础框架搭建
- [ ] 创建项目目录结构
- [ ] 配置FastAPI基础应用
- [ ] 集成python-telegram-bot
- [ ] 配置数据库连接
- [ ] 编写配置文件和.env

### 阶段二：数据库实现
- [ ] 定义数据库模型
- [ ] 实现数据库初始化脚本
- [ ] 编写CRUD操作函数

### 阶段三：核心功能开发
- [ ] 实现价格解析服务
- [ ] 实现订单消息处理
- [ ] 实现账单累计逻辑
- [ ] 实现基础命令（/start, /bill）

### 阶段四：权限与指令
- [ ] 实现权限验证系统
- [ ] 实现管理员指令（+/-金额）
- [ ] 实现清账功能
- [ ] 实现管理员管理功能

### 阶段五：OCR功能（可选）
- [ ] 集成OCR服务
- [ ] 实现图片识别逻辑

### 阶段六：测试与优化
- [ ] 单元测试
- [ ] 集成测试
- [ ] 日志系统完善
- [ ] 错误处理优化

---

## 七、配置说明

### 7.1 环境变量 (.env)

```env
# Telegram Bot配置
BOT_TOKEN=your_bot_token_here

# 超级管理员ID（逗号分隔）
SUPER_ADMIN_IDS=123456789,987654321

# 数据库配置
DATABASE_URL=sqlite:///./data/bot.db

# API配置
API_HOST=0.0.0.0
API_PORT=8000

# 日志配置
LOG_LEVEL=INFO
LOG_FILE=logs/bot.log
```

### 7.2 依赖包 (requirements.txt)

```
fastapi>=0.104.0
uvicorn>=0.24.0
python-telegram-bot>=20.7
sqlalchemy>=2.0.0
aiosqlite>=0.19.0
pydantic>=2.5.0
python-dotenv>=1.0.0
aiohttp>=3.9.0
```

---

## 八、订单示例

### 示例1：普通订单

```
a d程
13045201820
黑龙江省齐齐哈尔市依安县依安镇翰林新居六栋一单元

雪茄鸭嘴兽 铁观音 绿豆 备选龙井
高维 绿豆 备选蓝莓
总186
```

**识别结果：** 186

### 示例2：带算式订单

```
A d程
13045201820
黑龙江省齐齐哈尔市依安县依安镇翰林新居六栋一单元

雪茄鸭嘴兽 铁观音 绿豆 备选龙井
高维 绿豆 备选蓝莓
总60*2+60+6=186
```

**识别结果：** 186（验证算式：60*2+60+6=186 ✓）

### 示例3：无效订单（无前缀，不触发）

```
d程
13045201820
...
总186
```

**识别结果：** 忽略，不处理（缺少 a/A 前缀）

---

## 九、使用流程

### 9.1 普通用户报单流程

```
1. 用户在消息前添加 a 或 A 前缀，发送订单（文本或图片）
   ↓
2. 机器人检测到前缀，开始解析价格
   ↓
3. 机器人回复确认信息（识别到的金额）
   ↓
4. 金额累加到群组账单
   ↓
5. 用户可随时输入 /账单 查看当前总额
```

**重要提示：**
- 必须以 `a` 或 `A` 开头才会触发识别
- 没有 `a/A` 前缀的消息会被忽略，不会记入账单

### 9.2 管理员操作流程

```
1. 管理员输入 +100
   → 账单增加100元

2. 管理员输入 -50
   → 账单减少50元

3. 管理员输入 清账
   → 当前群组账单清零
   → 删除该群组的所有订单记录
   → 删除该群组的所有交易记录
   → 保留群组基本信息和管理员配置
```

### 9.3 清账数据清理详情

当管理员执行 `清账` 操作时，系统将执行以下数据库操作：

| 操作 | 数据表 | 处理方式 |
|------|--------|----------|
| 清零金额 | groups | 将 `total_amount` 设为 0 |
| 删除订单 | orders | 删除该 `chat_id` 的所有记录 |
| 删除交易 | transactions | 删除该 `chat_id` 的所有记录 |
| 保留群组 | groups | 保留群组记录，仅更新金额 |
| 保留管理员 | admins | 保留管理员配置不变 |

**清账目的：** 防止数据库随时间增长而膨胀，定期清理历史订单数据。

---

## 十、注意事项

1. **安全性**
   - 管理员操作需要记录日志
   - 敏感操作需要二次确认

2. **数据准确性**
   - 价格识别失败时提示用户重新发送
   - 算式计算不一致时发出警告

3. **用户体验**
   - 提供清晰的命令提示
   - 操作结果及时反馈
   - **报单必须添加 a/A 前缀，否则不会识别**

4. **数据维护**
   - 清账操作会永久删除该群组的历史订单和交易记录
   - 清账前建议管理员导出重要数据（如需）
   - 定期清账可有效控制数据库大小
   - 被删除的数据无法恢复，请谨慎操作

---

*文档版本: v1.2*
*创建日期: 2026-01-14*
*更新日期: 2026-01-14*
*更新内容: 新增 a/A 前缀触发机制*
